<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Countdown Nghỉ Lễ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Thêm thư viện lunar-javascript -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/dist/lunar.min.js"></script>
    <link rel="stylesheet" href="/src/styles/main.css" />
</head>

<body class="p-6">
    <header class="text-center mb-12 relative">
            <h1 class="text-5xl font-bold mb-4 text-indigo-600">Countdown Nghỉ Lễ</h1>
        <p class="text-gray-600 mb-4">Đếm ngược đến những ngày lễ đặc biệt của Việt Nam</p>
        
        <!-- Dòng hiển thị ngày giờ hiện tại -->
        <div class="current-time-display bg-white/90 rounded-lg p-4 max-w-3xl mx-auto shadow-md border border-indigo-100">
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <i class="fas fa-calendar-day text-indigo-500"></i>
                    <span class="font-medium text-gray-700">Hôm nay:</span>
                    <span id="currentDate" class="font-semibold text-indigo-700">--</span>
        </div>
                <div class="flex items-center gap-2">
                    <i class="fas fa-clock text-indigo-500"></i>
                    <span class="font-medium text-gray-700">Giờ:</span>
                    <span id="currentTime" class="font-semibold text-indigo-700">--:--:--</span>
    </div>
                <div class="flex items-center gap-2">
                    <i class="fas fa-moon text-indigo-500"></i>
                    <span class="font-medium text-gray-700">Âm lịch:</span>
                    <span id="currentLunarDate" class="font-semibold text-indigo-700">--/--/----</span>
                </div>
                </div>
        </div>
    </header>

    <!-- Container chính với max-width cố định -->
    <div class="countdown-container max-w-6xl mx-auto">
        <!-- Container cho thẻ đếm ngược chính, sẽ được JS chèn vào -->
        <div id="main-countdown-container"></div>

        <!-- Container cho các thẻ đếm ngược nhỏ, sẽ được JS chèn vào -->
        <div id="small-countdowns-container" class="small-countdowns-grid"></div>
        </div>

    <!-- JavaScript Module -->
    <script type="module">
        
        import { HOLIDAYS_DATA as holidays } from '/data/holidays.js';
        import { LunarDateConverter } from '/src/modules/LunarDateConverter.js';

        // --- TEMPLATE GENERATION FUNCTIONS ---

        /**
         * Tạo mã HTML cho thẻ đếm ngược chính (loại lớn).
         */
        function generateMainCardHTML(holiday) {
            return `
                <section id="${holiday.idPrefix}Container" class="${holiday.themeClass} main-countdown-card rounded-2xl p-8 mb-8 shadow-lg relative">
                    <div class="flex items-center justify-center mb-4">
                        <i class="fas ${holiday.iconClass} festival-icon text-3xl mr-4"></i>
                        <h2 class="text-4xl font-bold">${holiday.title}</h2>
                    </div>
                    ${holiday.note ? `<h3 class="text-xl mb-8 text-center">${holiday.note}</h3>` : ''}
                    <div id="countdown-${holiday.idPrefix}" class="flex flex-wrap justify-center gap-6">
                        <div class="time-block main-time-block">
                            <span id="${holiday.idPrefix}-month" class="time-value">0</span>
                            <span class="time-label">Tháng</span>
                        </div>
                        <div class="time-block main-time-block">
                            <span id="${holiday.idPrefix}-day" class="time-value">0</span>
                            <span class="time-label">Ngày</span>
                        </div>
                        <div class="time-block main-time-block">
                            <span id="${holiday.idPrefix}-hour" class="time-value">00</span>
                            <span class="time-label">Giờ</span>
                        </div>
                        <div class="time-block main-time-block">
                            <span id="${holiday.idPrefix}-minute" class="time-value">00</span>
                            <span class="time-label">Phút</span>
                        </div>
                        ${holiday.showSeconds ? `
                        <div class="time-block main-time-block">
                            <span id="${holiday.idPrefix}-second" class="time-value">00</span>
                            <span class="time-label">Giây</span>
                        </div>` : ''}
                    </div>
                </section>
            `;
        }

        /**
         * Tạo mã HTML cho thẻ đếm ngược phụ (loại nhỏ).
         */
        function generateSmallCardHTML(holiday) {
            return `
                <div id="${holiday.idPrefix}Container" class="${holiday.themeClass} small-countdown-card rounded-xl p-6 shadow-lg relative">
                    <div class="flex items-center justify-center mb-3">
                        <i class="fas ${holiday.iconClass} festival-icon text-xl mr-2"></i>
                        <h2 class="text-lg font-bold text-center">${holiday.title}</h2>
                    </div>
                    ${holiday.note ? `<h3 class="text-sm mb-4 text-center">${holiday.note}</h3>` : ''}
                    <div id="countdown-${holiday.idPrefix}" class="flex align-items-center justify-center flex-1">
                        <div class="compact-countdown">
                            <div class="compact-time-display">
                                <span id="${holiday.idPrefix}-month" class="time-number">0</span>
                                <span class="time-separator">:</span>
                                <span id="${holiday.idPrefix}-day" class="time-number">00</span>
                                <span class="time-separator">:</span>
                                <span id="${holiday.idPrefix}-hour" class="time-number">00</span>
                                <span class="time-separator">:</span>
                                <span id="${holiday.idPrefix}-minute" class="time-number">00</span>
                            </div>
                            <div class="compact-time-labels">
                                <span class="compact-label">Tháng</span>
                                <span class="compact-label">Ngày</span>
                                <span class="compact-label">Giờ</span>
                                <span class="compact-label">Phút</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Hàm cập nhật ngày giờ hiện tại
        function updateCurrentDateTime() {
            const now = new Date();
            
            // Cập nhật ngày dương lịch
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const currentDateStr = now.toLocaleDateString('vi-VN', dateOptions);
            
            // Cập nhật giờ
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            };
            const currentTimeStr = now.toLocaleTimeString('vi-VN', timeOptions);
            
            // Cập nhật âm lịch sử dụng LunarDateConverter module
            const converter = new LunarDateConverter();
            const lunarDate = converter.getCurrentLunarInfo();
            const currentLunarStr = `${lunarDate.day}/${lunarDate.month}/${lunarDate.year}${lunarDate.isLeap ? ' (nhuận)' : ''}`;
            
            // Cập nhật DOM
            const currentDateEl = document.getElementById('currentDate');
            const currentTimeEl = document.getElementById('currentTime');
            const currentLunarEl = document.getElementById('currentLunarDate');
            
            if (currentDateEl) currentDateEl.textContent = currentDateStr;
            if (currentTimeEl) currentTimeEl.textContent = currentTimeStr;
            if (currentLunarEl) currentLunarEl.textContent = currentLunarStr;
        }

        // Hàm tính toán thời gian còn lại
        function calculateTimeRemaining(targetDate) {
            const now = new Date();
            const target = new Date(targetDate);
            
            if (target <= now) {
                target.setFullYear(target.getFullYear() + 1);
            }
            
            const diff = target - now;
            
            const totalSeconds = Math.floor(diff / 1000);
            const totalMinutes = Math.floor(totalSeconds / 60);
            const totalHours = Math.floor(totalMinutes / 60);
            const totalDays = Math.floor(totalHours / 24);
            
            // Tính tháng và ngày chính xác hơn
            let tempNow = new Date(now);
            let tempTarget = new Date(target);
            
            let months = 0;
            while (
                new Date(tempNow.getFullYear(), tempNow.getMonth() + 1, tempNow.getDate()) <= tempTarget
            ) {
                months++;
                tempNow.setMonth(tempNow.getMonth() + 1);
            }
            
            // Tính số ngày còn lại sau khi đã tính tháng
            const days = Math.floor((tempTarget - tempNow) / (1000 * 60 * 60 * 24));
            
            const hours = totalHours % 24;
            const minutes = totalMinutes % 60;
            const seconds = totalSeconds % 60;
            
            return { months, days, hours, minutes, seconds };
        }

        // Hàm cập nhật hiển thị countdown
        function updateCountdown(holiday) {
            const { months, days, hours, minutes, seconds } = calculateTimeRemaining(holiday.targetDate);
            
            const monthEl = document.getElementById(`${holiday.idPrefix}-month`);
            const dayEl = document.getElementById(`${holiday.idPrefix}-day`);
            const hourEl = document.getElementById(`${holiday.idPrefix}-hour`);
            const minuteEl = document.getElementById(`${holiday.idPrefix}-minute`);
            const secondEl = document.getElementById(`${holiday.idPrefix}-second`);
            
            if (monthEl) monthEl.textContent = String(months);
            if (dayEl) dayEl.textContent = String(days).padStart(2, '0');
            if (hourEl) hourEl.textContent = String(hours).padStart(2, '0');
            if (minuteEl) minuteEl.textContent = String(minutes).padStart(2, '0');
            if (secondEl && holiday.showSeconds) {
                secondEl.textContent = String(seconds).padStart(2, '0');
            }
        }

        // Hàm cập nhật tất cả countdown
        function updateAllCountdowns() {
            holidays.forEach(holiday => {
                updateCountdown(holiday);
            });
            updateCurrentDateTime();
        }

        // --- INITIALIZATION ---

        /**
         * Khởi tạo trang, "vẽ" các thẻ đếm ngược từ dữ liệu.
         */
        function initializePage() {
            const mainContainer = document.getElementById('main-countdown-container');
            const smallContainer = document.getElementById('small-countdowns-container');

            holidays.forEach(holiday => {
                if (holiday.main) {
                    mainContainer.innerHTML += generateMainCardHTML(holiday);
                } else {
                    smallContainer.innerHTML += generateSmallCardHTML(holiday);
                }
            });
        }

        // Khởi tạo và cập nhật countdown
        document.addEventListener('DOMContentLoaded', () => {
            initializePage(); // "Vẽ" các thẻ đếm ngược trước
            updateAllCountdowns();
            setInterval(updateAllCountdowns, 1000);
        });
    </script>
</body>
</html>
